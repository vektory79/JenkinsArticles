# SonarQube и IntelliJ IDEA: правильная интеграция

## Введение

[SonarQube](http://www.sonarqube.org/) - отличный инструмент для внедрения статического анализа кода в процесс 
разработки ПО на Java. Он объединяет возможности таких инструментов, как [FindBugs](http://findbugs.sourceforge.net/),
[CheckStyle](http://checkstyle.sourceforge.net/) и [PMD](https://pmd.github.io/), а так же содержит
собственные инспекции. Каждую отдельную инспекцию можно настраивать индивидуально, а так же объединять их в 
профили, позволяя иметь единый набор инспекций для всего предприятия. Найденные замечания отображаются на WEB
интерфейсе, где ими можно удобно управлять.

Но беда в том, что удобный WEB интерфейс не означает удобство по устранению найденных замечаний в коде проекта.
Для того, чтобы внести исправление приходится сначала смотреть в каком именно файле это замечание обнаружено, 
потом открывать этот файл и только потом вносить исправление. Так же это приводит к тому, что разработчик узнает
о проблеме с очень большим отставанием (иногда анализ в SonarQube может занимать часы). Что не способствует 
поддержанию чистоты кода.

Для решения этой проблемы различные IDE имеют плагины, позволяющие вынимать информацию с сервера SonarQube и
отображать её прямо в редакторе кода. В случае с IntelliJ IDEA это два плагина. 

Первый (более старый) - это
[SonarQube IntelliJ Community Plugin](https://github.com/sonar-intellij-plugin/sonar-intellij-plugin). Честно
говоря остаётся полной загадкой, как авторы предполагают его использовать. Мало того, что его надо индивидуально
подключать к каждому модулю проекта (привет многомодульные Maven проекты с многими десятками модулей), так ещё
и замечания показываются статически исключительно из SonarQube. Как следствие даже при исправлении замечания
локально оно всё равно остаётся висеть до тех пор, пока не пройдёт новый анализ на сервере.

Второй плагин - [SonarLint](http://www.sonarlint.org/intellij/) - официальный плагин от разработчиков самого
SonarQube. Берёт с сервера только профиль с настройками активных инспекций, а сам анализ делает налету прямо
в IDE. Это значительно повышает качество разработки, позволяя сразу видеть все новые замечания и оперативно
их исправлять. Но и тут есть бочка дёгтя. SonarLint работает исключительно с собственными инспекциями SonarQube,
полностью игнорируя все остальные инспекции. Ни замечаний от FindBugs ни от CheckStyle или PMD вы не увидите.
А ведь там может содержаться подавляющее большинство ценной информации.

Но не стоит отчаиваться - сервер SonarQube умеет экспортировать настройки для всех анализаторов, а значит
имеется возможность настроить штатные плагины IDEA так, чтобы они выдавали эквивалентный результат с сервером.
Как это сделать и будет разобрано далее.

## Настройка SonarLint

Тут нет никаких хитростей. Идём в настройки IDEA и в разделе `Plugins` нажимаем кнопку `Browse repositories...`.
Находим плагин **[SonarLint](http://www.sonarlint.org/intellij/)** и устанавливаем его. Плагин начинает работать сразу, используя настройки инспекции
по умолчанию. Теперь можно перейти в окно плагина и сконфигурировать подключение в серверу SonarQube:

![SonarLintWindow]

![SonarLintSettings1]

![SonarLintSettings2]

![SonarLintSettings3]

Главное не забыть нажать `Update binding` после добавления нового сервера, чтобы плагин загрузил профиль с настройками.
Так же эту кнопку придётся нажимать всякий раз, когда профиль изменился на сервере (добавили/удалил инспекции,
изменили их настройки).

Так же, если у вас подключено несколько модулей в один проект IDEA, то в настройках придётся переключаться
на конкретный модуль всякий раз, когда вам его надо будет проанализировать на предмет замечаний. Что не очень
удобно, но как есть.

Список замечаний будет обновляться автоматически в фоновом режиме всякий раз, когда открывается новый файл или
в этот файл вносятся изменения. Если такое поведение нежелательно, то его можно отключить там же в настройках
плагина.

## Выгрузка настроек анализаторов из SonarQube

Для каждого из плагинов, кроме SonarLint необходимы свои файлы настроек каждый в собственном формате. К счастью
SonarQube умеет выгружать эти файлы. Они находятся в окне настройки профиля анализа.

Для того, чтобы туда попасть необходимо на сайте SonarQube перейти
в раздел `Quality Profile` и выбрать тот профиль, который используется для анализа проекта:

![SonarQubeProfiles1]

На появившейся странице появится раздел, предоставляющий ссылки для экспорта настроек под каждый из анализаторов:

![SonarQubeProfiles2]

Настройки для FindBugs и PMD необходимо выгрузить на локальный диск с расширением `XML`, а вот настройки для CheckStyle можно использовать
прямо по URL с сайта.

## Настройка CheckStyle

В IDEA плагин называется **[CheckStyle-IDEA](https://github.com/jshiell/checkstyle-idea)**. Это пожалуй самый
безпроблемный с точки зрения использования плагин т.к. позволяет загрузить настройки прямо по URL и не требует
переключения между модулями, как SonarLint.

Для подключения конфигурации необходимо перейти в настройки IDEA и выбрать раздел `CheckStyle`. Далее необходимо
добавить новый пункт в таблицу `Configuration File`:

![Checkstyle1]

И указать источник конфигурации:

![Checkstyle2]

В случае ошибки "The Checkstyle rules file could not be parsed", а именно "SuppressionCommentFilter is not allowed as a child in Checker" нужно понизить версию Checkstyle в настройках плагина до 8.0.

Так же не забываем отметить вновь добавленную конфигурацию как активную в таблице.

Всё теперь можно переходить в окно CheckStyle и запускать анализ (верхняя отмеченная кнопка):

![Checkstyle3]

В случае, если профиль на сервере SonarQube поменялся, то необходимо обновить настройки путём нажатия соответствующей 
кнопки в том же окне (нижняя отмеченная кнопка).

## Настройка FindBugs

В IDEA плагин называется **[FindBugs-IDEA](http://andrepdo.github.io/findbugs-idea/)**. В отличии от предыдущих
рассмотренных плагинов, этот не умеет брать настройки напрямую с сервера и требует наличия локального файла.

Для подключения конфигурации необходимо перейти в настройки IDEA и выбрать раздел `FindBugs-IDEA`. Далее необходимо
на вкладке `Filter` добавить новый пункт в таблицу `Include filter files`:

![FindBugs1]

Плагин готов к работе. В окне плагина можно запустить анализ как отдельного файла так и всего проекта, или
любого для любого другого скопа на выбор:

![FindBugs2]

**Важное замечание 1:** в настройках плагина имеется вкладка `Share`, в которой предлагается подключить файл настроек
SonarQube. Пользоваться этой настройкой не рекомендую, т.к. корректно оно не заработало, а вот последствия лечатся
нетривиально. Дело в том, что просто удаление этой настройки ничего не дало. Плагин не начал работать нормально.
Для восстановления работы пришлось удалить файл `.idea/findbugs-idea.xml` в каталоге проекта и перенастроить всё
заново.

**Важное замечание 2:** если настройки на сервере SonarQube изменились, то необходимо не забыть выгрузить эти
настройки заново на диск.

## Настройка PMD

В IDEA плагин называется **PMDPlugin**. Аналогично с FindBugs, этот плагин требует наличия файла настроек на диске.
Для конфигурирования идём в настройки IDEA и добавляем файл с настройками:

![PMD1]

Имя файла имеет важную роль, т.к. в дальнейшем оно будет использовано плагином для формирования соответствующего пункта
меню для запуска анализа.

Так же в соседней вкладе необходимо указать ту версию Java, которую использует проект (ну и кодировку заодно):

![PMD2]

Теперь можно запустить анализ текущего файла, воспользовавшись контекстным меню:
 
```
Run PMD->Custom Rules-><Имя файла настроек>
```

**Важное замечание 1:** PMD можно так же запустить через главное меню, но делать это не рекомендуется, т.к. в этом случае
проверке подвергнется не один файл, а весь открытый в IDE проект. Это может занять много времени и значительно 
перегрузить систему.

**Важное замечание 2:** как и FindBugs, PMD требует наличия файла конфигурации на диске. Следовательно необходимо 
обновлять его каждый раз, как настройки профиля SonarQube изменяются.

## Заключение

Несмотря на то, что для отслеживания замечаний приходится управлять настройками целых 4-х плагинов, это всё же лучше,
чем каждый раз ждать пока результаты редактирования появятся на сервере SonarQube и позволяет сразу коммитить более 
чистый код.

Надеюсь, что изложенная здесь информация поможет кому-нибудь легче подружиться со статическими анализаторами вообще и с
SonarQube в частности.

[SonarLintWindow]: images/SonarLintWindow.png "Окно плагина SonarLint"

[SonarLintSettings1]: images/SonarLintSettings1.png "Окно настроек SonarLint"
[SonarLintSettings2]: images/SonarLintSettings2.png "Окно настройки серверов SonarQube"
[SonarLintSettings3]: images/SonarLintSettings3.png "Окно настройки отдельного сервера SonarQube"

[SonarQubeProfiles1]: images/SonarQubeProfiles1.png "Список профилей SonarQube"
[SonarQubeProfiles2]: images/SonarQubeProfiles2.png "Информация о выбранном профиле SonarQube"

[Checkstyle1]: images/Checkstyle1.png "Окно настроек CheckStyle"
[Checkstyle2]: images/Checkstyle2.png "Окно добавления конфигурации для CheckStyle"
[Checkstyle3]: images/Checkstyle3.png "Окно замечаний CheckStyle"

[FindBugs1]: images/FindBugs1.png "Окно настроек FindBugs"
[FindBugs2]: images/FindBugs2.png "Окно замечаний FindBugs"

[PMD1]: images/PMD1.png "Окно настроек PMD для добавления файла профиля"
[PMD2]: images/PMD2.png "Окно настроек PMD для указания дополнительных параметров"
